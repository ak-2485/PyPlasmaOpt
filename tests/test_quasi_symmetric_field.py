import numpy as np
import pytest
from pyplasmaopt import QuasiSymmetricField, get_matt_data

def test_sigma():
    nfp = 2
    _, ma = get_matt_data(Nt=4, nfp=nfp, ppp=40)
    eta_bar = -2.25
    B_qs = QuasiSymmetricField(eta_bar, ma)
    sigma, iota = B_qs.solve_state()
    sigma_matlab = np.asarray([
        -0.000000000000000, -0.056185092625620, -0.112382986380741, -0.168606294739314, -0.224867254805832, -0.281177536480886, -0.337548048436650, -0.393988739822343, -0.450508396607183, -0.507114431454616, -0.563812666008344, -0.620607104459419, -0.677499697256753, -0.734490093823280, -0.791575383149675, -0.848749821160578, -0.906004543788638, -0.963327264754031, -1.020701957136678, -1.078108517951100, -1.135522415096348, -1.192914316262969, -1.250249699643717, -1.307488446623194, -1.364584417023181, -1.421485007964753, -1.478130697985200, -1.534454578727070, -1.590381877307561, -1.645829473387029, -1.700705415991899, -1.754908446313264, -1.808327533997705, -1.860841435865964, -1.912318287526287, -1.962615239972233, -2.011578154939745, -2.059041374503194, -2.104827582059986, -2.148747773417560, -2.190601358069108, -2.230176411822216, -2.267250102609442, -2.301589311429245, -2.332951469797540, -2.361085633687722, -2.385733811557786, -2.406632560578662, -2.423514860486942, -2.436112268528834, -2.444157351739409, -2.447386384385629, -2.445542288955833, -2.438377788865210, -2.425658730435253, -2.407167521167246, -2.382706621428404, -2.352102018033593, -2.315206601494947, -2.271903364568463, -2.222108338719867, -2.165773187697747, -2.102887383784994, -2.033479902503788, -1.957620385304120, -1.875419736514573, -1.787030139750048, -1.692644499001194, -1.592495329566807, -1.486853142563567, -1.376024382731296, -1.260348991572805, -1.140197675702519, -1.015968963133882, -0.888086127997064, -0.756994057124279, -0.623156120721537, -0.487051094933613, -0.349170167713112, -0.210014042374294, -0.070090136929009, 0.070090136929009, 0.210014042374294, 0.349170167713112, 0.487051094933614, 0.623156120721537, 0.756994057124279, 0.888086127997064, 1.015968963133882, 1.140197675702519, 1.260348991572805, 1.376024382731296, 1.486853142563567, 1.592495329566807, 1.692644499001194, 1.787030139750048, 1.875419736514573, 1.957620385304121, 2.033479902503789, 2.102887383784994, 2.165773187697748, 2.222108338719868, 2.271903364568463, 2.315206601494947, 2.352102018033593, 2.382706621428404, 2.407167521167246, 2.425658730435254, 2.438377788865211, 2.445542288955834, 2.447386384385629, 2.444157351739409, 2.436112268528835, 2.423514860486943, 2.406632560578662, 2.385733811557786, 2.361085633687722, 2.332951469797541, 2.301589311429245, 2.267250102609442, 2.230176411822216, 2.190601358069108, 2.148747773417560, 2.104827582059986, 2.059041374503194, 2.011578154939746, 1.962615239972234, 1.912318287526287, 1.860841435865964, 1.808327533997705, 1.754908446313264, 1.700705415991898, 1.645829473387029, 1.590381877307561, 1.534454578727070, 1.478130697985200, 1.421485007964753, 1.364584417023181, 1.307488446623194, 1.250249699643717, 1.192914316262969, 1.135522415096348, 1.078108517951100, 1.020701957136678, 0.963327264754031, 0.906004543788638, 0.848749821160577, 0.791575383149675, 0.734490093823280, 0.677499697256752, 0.620607104459418, 0.563812666008344, 0.507114431454616, 0.450508396607183, 0.393988739822343, 0.337548048436650, 0.281177536480886, 0.224867254805832, 0.168606294739314, 0.112382986380741, 0.056185092625620,
   ])
    assert all(np.abs(sigma-sigma_matlab) < 1e-8)

def test_iota():
    nfp = 2
    _, ma = get_matt_data(Nt=4, nfp=nfp, ppp=20)
    eta_bar = -2.25
    B_qs = QuasiSymmetricField(eta_bar, ma)
    sigma, iota = B_qs.solve_state()
    assert (abs(iota-0.038138935935663) < 1e-6)

def test_Bqs():
    nfp = 2
    _, ma = get_matt_data(Nt=4, nfp=nfp, ppp=100)
    eta_bar = -2.25
    B_qs = QuasiSymmetricField(eta_bar, ma)
    sigma, iota = B_qs.solve_state()
    assert (abs(iota-0.038138935935663) < 1e-6)

    Bqs = B_qs.B()
    matlab_Bqs = np.asarray([
        [0                ,   0.988522982100515,  -0.151070559206963],
        [-0.010321587904285,   0.988472377058748,  -0.151049080152652],
        [-0.020641457945632,   0.988320578381101,  -0.150984650088425]])
    assert np.all(np.abs(Bqs[:3,:] - matlab_Bqs) < 1e-6)

    dBqs_by_dX = B_qs.dB_by_dX()
    assert np.allclose(dBqs_by_dX[0, : ,:].T, dBqs_by_dX[0, :, :])
    matlab_dBqs_by_dx = np.asarray([
        [ 0.000000000000000,  -1.125930207500723 ,  0.616014274297893],
        [ 0.030176925011424,  -1.125619099754597 ,  0.615869343228699],
        [ 0.060336364146126,  -1.124686016345258 ,  0.615434630935356]])
    assert np.all(np.abs(matlab_dBqs_by_dx-dBqs_by_dX[:3,0,:])<2e-6)
    
    matlab_dBqs_by_dy = np.asarray([
        [-1.125930207500723 , -0.000000000000000 , -0.000000000000000],
        [-1.125619099754597 , -0.022146228771976 ,  0.010281638036739],
        [-1.124686016345258 , -0.044277063777819 ,  0.020556281775495]])
    assert np.all(np.abs(matlab_dBqs_by_dy-dBqs_by_dX[:3,1,:])<2e-6)
    matlab_dBqs_by_dz = np.asarray([
       [0.616014274297891,  -0.000000000000000,  -0.000000000000000],
       [0.615869343228698,   0.010281638036739,  -0.008030696239448],
       [0.615434630935353,   0.020556281775495,  -0.016059300368306]])
    assert np.all(np.abs(matlab_dBqs_by_dz-dBqs_by_dX[:3,2,:])<2e-6)
